<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта заболеваемости врожденными аномалиями СЗФО</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .map-wrapper {
            position: relative;
            width: 100%;
            height: 600px;
            border: 3px solid #ddd;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .info-panel {
            padding: 20px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
        }
        
        #region-info {
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            min-height: 100px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f2f2f2;
        }
        
        .highlight {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
        }
        
        .controls {
            padding: 10px 20px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .year-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        #map-title {
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Карта заболеваемости врожденными аномалиями в СЗФО</h1>
            <p>Кликните на регион для просмотра данных</p>
        </header>
        
        <div class="controls">
            <div class="year-selector">
                <span>Год:</span>
                <select id="yearSelect">
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                </select>
            </div>
            <div id="map-title">Заболеваемость на 100 000 населения</div>
        </div>
        
        <div class="map-wrapper">
            <div id="map"></div>
            <div class="loading" id="loading">Загрузка карты...</div>
        </div>
        
        <div class="info-panel">
            <h3>Информация о регионе:</h3>
            <div id="region-info">
                Выберите регион на карте для отображения данных
            </div>
        </div>
    </div>

    <script src="mapdata.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loading = document.getElementById('loading');
            const regionInfo = document.getElementById('region-info');
            const yearSelect = document.getElementById('yearSelect');
            const mapTitle = document.getElementById('map-title');
            
            let currentSelectedRegionId = null;
            let currentViewMode = 'district';
            
            // Определяем регионы СЗФО
            const szfoRegions = [
                'RUARK', 'RUNEN', 'RUKR', 'RULEN', 'RUMUR', 'RUNGR', 'RUPSK', 'RUSPE', 'RUVLG', 'RUKGD'
            ];

            // Скрываем все регионы, которые не входят в СЗФО
            for (const regionCode in simplemaps_countrymap_mapdata.state_specific) {
                if (!szfoRegions.includes(regionCode)) {
                    const region = simplemaps_countrymap_mapdata.state_specific[regionCode];
                    region.hide = "yes";
                    region.inactive = "yes";
                    region.color = "#f0f0f0";
                }
            }
            
            // Функция обновления данных регионов для выбранного года
            function updateRegionsForYear(year) {
                for (const regionCode of szfoRegions) {
                    const region = simplemaps_countrymap_mapdata.state_specific[regionCode];
                    
                    if (region.morbidity && region.morbidity[year]) {
                        const data = region.morbidity[year].congenital_anomalies;
                        
                        region.description = `
                            <strong>${region.name}</strong><br/>
                            Данные за ${year} год:<br/>
                            Абсолютное число: ${data.absolute_numbers.toLocaleString()}<br/>
                            На 100 000 населения: ${data.per_100000.toFixed(1)}
                        `;
                        
                        const rate = data.per_100000;
                        if (rate > 8000) {
                            region.color = "#8B0000";
                        } else if (rate > 6000) {
                            region.color = "#FF4500";
                        } else if (rate > 4000) {
                            region.color = "#FFA500";
                        } else if (rate > 2000) {
                            region.color = "#FFD700";
                        } else {
                            region.color = "#F0E68C";
                        }
                    } else if (region.morbidity) {
                        const years = Object.keys(region.morbidity).sort().reverse();
                        if (years.length > 0) {
                            const latestYear = years[0];
                            const data = region.morbidity[latestYear].congenital_anomalies;
                            region.description = `
                                <strong>${region.name}</strong><br/>
                                Данные за ${latestYear} год (${year} недоступен):<br/>
                                Абсолютное число: ${data.absolute_numbers.toLocaleString()}<br/>
                                На 100 000 населения: ${data.per_100000.toFixed(1)}
                            `;
                        } else {
                            region.description = `<strong>${region.name}</strong><br/>Данные отсутствуют`;
                        }
                        region.color = "#D3D3D3";
                    } else {
                        region.description = `<strong>${region.name}</strong><br/>Данные о заболеваемости отсутствуют`;
                        region.color = "#D3D3D3";
                    }
                }
            }
            
            function loadMapScript() {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'countrymap.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            // Функция показа данных региона
            function showRegionData(regionId) {
                const region = simplemaps_countrymap_mapdata.state_specific[regionId];
                const selectedYear = yearSelect.value;
                
                if (!region) {
                    regionInfo.innerHTML = '<div class="highlight">Регион не найден</div>';
                    return;
                }
                
                currentSelectedRegionId = regionId;
                currentViewMode = 'region';
                
                let html = `<div class="highlight">${region.name}</div>`;
                
                if (region.morbidity) {
                    if (region.morbidity[selectedYear]) {
                        const data = region.morbidity[selectedYear].congenital_anomalies;
                        html += `
                            <div><strong>Данные за ${selectedYear} год:</strong></div>
                            <div>Абсолютное число случаев: ${data.absolute_numbers.toLocaleString()}</div>
                            <div>На 100 000 населения: ${data.per_100000.toFixed(1)}</div>
                        `;
                    } else {
                        const years = Object.keys(region.morbidity).sort().reverse();
                        if (years.length > 0) {
                            const latestYear = years[0];
                            const data = region.morbidity[latestYear].congenital_anomalies;
                            html += `
                                <div><strong>Данные за ${latestYear} год (${selectedYear} недоступен):</strong></div>
                                <div>Абсолютное число случаев: ${data.absolute_numbers.toLocaleString()}</div>
                                <div>На 100 000 населения: ${data.per_100000.toFixed(1)}</div>
                            `;
                        } else {
                            html += '<div>Данные о заболеваемости отсутствуют</div>';
                        }
                    }
                    
                    html += '<table class="data-table">';
                    html += '<tr><th>Год</th><th>Абс. число</th><th>На 100 000</th></tr>';
                    
                    const years = Object.keys(region.morbidity).sort().reverse();
                    years.forEach(year => {
                        const data = region.morbidity[year].congenital_anomalies;
                        html += `
                            <tr>
                                <td>${year}</td>
                                <td>${data.absolute_numbers.toLocaleString()}</td>
                                <td>${data.per_100000.toFixed(1)}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</table>';
                } else {
                    html += '<div>Данные о заболеваемости отсутствуют</div>';
                }
                
                regionInfo.innerHTML = html;
            }
            
            // Функция показа данных по СЗФО
            function showSzfoData() {
                const selectedYear = yearSelect.value;
                const szfoData = simplemaps_countrymap_mapdata.regions['8'];
                
                if (!szfoData) {
                    regionInfo.innerHTML = '<div class="highlight">Данные по СЗФО не найдены</div>';
                    return;
                }
                
                currentSelectedRegionId = null;
                currentViewMode = 'district';
                
                let html = `<div class="highlight">${szfoData.name} (Северо-Западный федеральный округ)</div>`;
                
                if (szfoData.morbidity) {
                    if (szfoData.morbidity[selectedYear]) {
                        const data = szfoData.morbidity[selectedYear].congenital_anomalies;
                        html += `
                            <div><strong>Данные за ${selectedYear} год:</strong></div>
                            <div>Абсолютное число случаев: ${data.absolute_numbers.toLocaleString()}</div>
                            <div>На 100 000 населения: ${data.per_100000.toFixed(1)}</div>
                        `;
                        
                        if (szfoData.births && szfoData.births[selectedYear]) {
                            html += `<div>Количество рождений: ${szfoData.births[selectedYear].toLocaleString()}</div>`;
                        }
                    } else {
                        const years = Object.keys(szfoData.morbidity).sort().reverse();
                        if (years.length > 0) {
                            const latestYear = years[0];
                            const data = szfoData.morbidity[latestYear].congenital_anomalies;
                            html += `
                                <div><strong>Данные за ${latestYear} год (${selectedYear} недоступен):</strong></div>
                                <div>Абсолютное число случаев: ${data.absolute_numbers.toLocaleString()}</div>
                                <div>На 100 000 населения: ${data.per_100000.toFixed(1)}</div>
                            `;
                        } else {
                            html += '<div>Данные о заболеваемости отсутствуют</div>';
                        }
                    }
                    
                    html += '<table class="data-table">';
                    html += '<tr><th>Год</th><th>Абс. число</th><th>На 100 000</th>';
                    
                    if (szfoData.births && Object.keys(szfoData.births).length > 0) {
                        html += '<th>Рождений</th>';
                    }
                    
                    html += '</tr>';
                    
                    const years = Object.keys(szfoData.morbidity).sort().reverse();
                    years.forEach(year => {
                        const data = szfoData.morbidity[year].congenital_anomalies;
                        html += `
                            <tr>
                                <td>${year}</td>
                                <td>${data.absolute_numbers.toLocaleString()}</td>
                                <td>${data.per_100000.toFixed(1)}</td>`;
                        
                        if (szfoData.births && szfoData.births[year]) {
                            html += `<td>${szfoData.births[year].toLocaleString()}</td>`;
                        } else if (szfoData.births) {
                            html += '<td>-</td>';
                        }
                        
                        html += '</tr>';
                    });
                    
                    html += '</table>';
                } else {
                    html += '<div>Данные о заболеваемости отсутствуют</div>';
                }
                
                regionInfo.innerHTML = html;
            }
            
            // Функция для настройки зума на СЗФО
            function zoomToSzfo() {
                if (typeof simplemaps_countrymap !== 'undefined' && simplemaps_countrymap.zoomToRegion) {
                    simplemaps_countrymap.zoomToRegion('8');
                }
            }
            
            // Инициализация карты
            async function initMap() {
                try {
                    await loadMapScript();
                    
                    setTimeout(() => {
                        if (typeof simplemaps_countrymap !== 'undefined') {
                            loading.style.display = 'none';
                            
                            const currentYear = yearSelect.value;
                            updateRegionsForYear(currentYear);
                            simplemaps_countrymap.refresh();
                            
                            document.getElementById('map').addEventListener('click', function(e) {
                                let target = e.target;
                                while (target && !target.getAttribute('data-id')) {
                                    target = target.parentElement;
                                }
                                
                                if (target && target.getAttribute('data-id')) {
                                    const regionId = target.getAttribute('data-id');
                                    showRegionData(regionId);
                                }
                            });
                            
                            setTimeout(() => {
                                zoomToSzfo();
                            }, 500);
                            
                            showSzfoData();
                        } else {
                            loading.innerHTML = 'Ошибка загрузки карты';
                        }
                    }, 1000);
                } catch (error) {
                    loading.innerHTML = 'Ошибка загрузки карты. Проверьте наличие countrymap.js';
                    console.error(error);
                }
            }
            
            // Обработчик изменения года
            yearSelect.addEventListener('change', function() {
                mapTitle.textContent = `Заболеваемость на 100 000 населения (${this.value} год)`;
                
                updateRegionsForYear(this.value);
                
                if (typeof simplemaps_countrymap !== 'undefined' && simplemaps_countrymap.refresh) {
                    simplemaps_countrymap.refresh();
                }
                
                if (currentViewMode === 'region' && currentSelectedRegionId) {
                    showRegionData(currentSelectedRegionId);
                } else {
                    showSzfoData();
                }
            });
            
            // Инициализируем карту
            initMap();
        });
    </script>
</body>
</html>
